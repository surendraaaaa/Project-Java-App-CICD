- name: Deploy Java App
  hosts: all
  become: yes
  vars_files:
    - ../vars/main.yml

  tasks:
    - name: Create deployment directory
      file:
        path: "{{ deploy_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: 0755

    - name: Download JAR for required version from S3
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "artifacts/build-{{ artifact_version }}.jar"
        dest: "/tmp/build-{{ artifact_version }}.jar"
        mode: get
      delegate_to: localhost
      become: false

    - name: Copy JAR to EC2
      copy:
        src: "/tmp/build-{{ artifact_version }}.jar"
        dest: "{{ deploy_dir }}/build-{{ artifact_version }}.jar"

    - name: Deploy systemd service template
      template:
        src: ../templates/legacy-java-app.service.j2
        dest: /etc/systemd/system/{{ systemd_service }}
      notify: Reload systemd

    - name: Restart service
      systemd:
        name: "{{ systemd_service }}"
        state: restarted
        enabled: yes

    - name: Wait for /health endpoint
      uri:
        url: "http://{{ ansible_host }}:8080/health"
        status_code: 200
        timeout: 20
      register: healthcheck
      until: healthcheck.status == 200
      retries: 5
      delay: 5

  handlers:
    - name: Reload systemd
      command: systemctl daemon-reload
