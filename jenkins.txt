pipeline {
    agent any

    parameters {
        choice(name: 'ENV', choices: ['dev', 'staging', 'prod'], description: 'Choose Environment to Deploy')
        booleanParam(name: 'ROLLBACK', defaultValue: false, description: 'Enable rollback instead of new deployment?')
        string(name: 'ROLLBACK_VERSION', defaultValue: '', description: 'Provide version (Build Number) to rollback to')
        text(name: 'EC2_REGIONS', defaultValue: 'us-east-1,us-east-2', description: 'Comma-separated list of EC2 regions to deploy to')
        choice(name: 'S3_REGION', choices: ['us-east-1', 'us-east-2', 'us-west-1', 'eu-west-1'], description: 'Region of S3 bucket')
    }

    environment {
        SCANNER_HOME = tool 'sonar-scanner'
        SONAR_HOST_URL = "http://3.12.196.109:9000"
    }

    stages {

        stage('Clean Workspace') {
            when { expression { return !params.ROLLBACK } }
            steps { cleanWs() }
        }

        stage('Git Checkout') {
            when { expression { return !params.ROLLBACK } }
            steps { git branch: 'main', url: 'https://github.com/surendraaaaa/Project-Java-App-CICD.git' }
        }

        stage('Maven Build & Package') {
            when { expression { return !params.ROLLBACK } }
            steps {
                dir('legacy-java-app') {
                    sh 'mvn clean install -DskipTests'
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'legacy-java-app/target/*.jar', fingerprint: true
                }
            }
        }

        stage('Trivy FS Scan') {
            when { expression { return !params.ROLLBACK } }
            steps {
                sh "trivy fs --format table -o fs-report-${BUILD_NUMBER}.html ."
            }
            post { always { archiveArtifacts artifacts: "fs-report-${BUILD_NUMBER}.html" } }
        }

        stage('Gitleaks Scan') {
            when { expression { return !params.ROLLBACK } }
            steps {
                sh "gitleaks detect --source . --report-path gitleaks-report-${BUILD_NUMBER}.json --report-format json --verbose"
            }
            post { always { archiveArtifacts artifacts: "gitleaks-report-${BUILD_NUMBER}.json" } }
        }

        stage('Sonar Scan') {
            when { expression { return !params.ROLLBACK } }
            steps {
                dir('legacy-java-app') {
                    withSonarQubeEnv('sonar') {
                        sh """
                        $SCANNER_HOME/bin/sonar-scanner \
                        -Dsonar.projectKey=devops \
                        -Dsonar.sources=src/main/java \
                        -Dsonar.java.binaries=target/classes
                        """
                    }
                }
            }
        }

        stage('Upload Artifact & Reports to S3') {
            when { expression { return !params.ROLLBACK } }
            steps {
                script {
                    // Dynamically set S3 bucket based on selected region
                    env.S3_BUCKET = "project1-javaapp-bucket-${params.S3_REGION}"
                }

                withAWS(credentials: 'aws-cred', region: params.S3_REGION) {
                    sh """
                    # Upload artifact
                    aws s3 cp legacy-java-app/target/legacy-java-app-1.0.0.jar \
                    s3://${S3_BUCKET}/artifacts/build-${BUILD_NUMBER}.jar

                    # Upload Trivy report
                    aws s3 cp fs-report-${BUILD_NUMBER}.html \
                    s3://${S3_BUCKET}/reports/fs-report-${BUILD_NUMBER}.html

                    # Upload Gitleaks report
                    aws s3 cp gitleaks-report-${BUILD_NUMBER}.json \
                    s3://${S3_BUCKET}/reports/gitleaks-report-${BUILD_NUMBER}.json
                    """
                }
            }
        }

        stage('Approval Before Deployment') {
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                    script {
                        if (!params.ROLLBACK) {
                            input "Deploy Build #${BUILD_NUMBER} to ${params.ENV}?"
                        } else {
                            input "Perform rollback of build #${params.ROLLBACK_VERSION} to ${params.ENV}?"
                        }
                    }
                }
            }
        }

        stage('Deploy via Ansible to Multiple Regions') {
            steps {
                script {
                    def ec2Regions = params.EC2_REGIONS.split(',')
                    for (region in ec2Regions) {
                        stage("Deploy to EC2 in ${region.trim()}") {
                            withEnv(["AWS_REGION=${region.trim()}", "ANSIBLE_HOST_KEY_CHECKING=False"]) {
                                dir("${WORKSPACE}/ansible") {
                                    sh """
                                    ansible-playbook -i inventories/${params.ENV}/ec2.py playbooks/deploy.yml \
                                    --extra-vars "artifact_version=${params.ROLLBACK ? params.ROLLBACK_VERSION : BUILD_NUMBER} env=${params.ENV} aws_region=${region.trim()}"
                                    """
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
